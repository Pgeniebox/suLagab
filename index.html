<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebSocket Server and Client Example</title>
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<style>
    body {
        background: #000;
        color: #fff;
        font-family: Arial, sans-serif;
        padding: 1rem;
        text-align: center;
    }
    video {
        width: 100%;
        height: 100%;
    }
</style>
<body>

<video id="remoteVideo"  autoplay controls></video>
<button id="connect">connect</button>
<script>
document.getElementById('remoteVideo').setAttribute('playsinline', '');
      let gt;
gt =  prompt('Enter your GitHub personal access token:');
if (!gt) {
    location.reload();
}
    let peer;
 peer = new Peer(); 

peer.on('open', function(id) {
  console.log('Connected to PeerJS server with ID:', id);
    
});



peer.on('call', call => {
    console.log('Incoming call from:', call);
    call.answer();
    call.on('error', err => console.error('call error:', err))
    call.on('stream', remoteStream => {
    console.log('Remote stream received:', remoteStream);
    document.getElementById('remoteVideo').srcObject = remoteStream;
   

});



})
const owner = 'pgeniebox';
const repo = 'cameraLagab';
const filePath = 'peer.json';
const token = gt; // your personal access token
const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${filePath}`;

async function getId() {
  let response = await fetch(apiUrl, {
    headers: { Authorization: `token ${token}` }
  });

  if (!response.ok) {
    location.reload();
  }

  // Parse the JSON that GitHub returns
  let fileData = await response.json();

  // Decode the base64-encoded content
  let content = atob(fileData.content); 

  // Trim any newlines GitHub might add
  return content.trim();
}

let id =  getId();
async function getPeerId() {
  try {
     id = await getId();
     console.log('Peer ID from GitHub:', id);
     peer.connect(id);
  } catch (error) {
    console.error('Error fetching peer ID:', error);
    throw error;
  }
}
getPeerId().catch(console.error);
document.getElementById('connect').addEventListener('click', () => {
  
    console.log('Connecting to PeerJS server...');
    getPeerId().catch(console.error);
  
});
//conn = peer.connect('');
//conn.send('ok');

</script>

</body>
</html>
